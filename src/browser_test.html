<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>토지 분석 API 브라우저 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .url-link {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        .url-link:hover {
            text-decoration: underline;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status.processing {
            background: #fff3cd;
            color: #856404;
        }
        .status.completed {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏡 토지 분석 API 브라우저 테스트</h1>
        
        <div class="section">
            <h3>1. 서버 상태 확인</h3>
            <button onclick="checkHealth()">헬스 체크</button>
            <button onclick="getApiInfo()">API 정보</button>
            <button onclick="getTasks()">활성 작업 목록</button>
            <div id="healthResult" class="result"></div>
        </div>

        <div class="section">
            <h3>2. 토지 분석 시작</h3>
            <p>아래 버튼을 클릭하면 샘플 데이터로 분석을 시작하고 로딩 페이지를 엽니다.</p>
            <button onclick="startAnalysis()">분석 시작 & 로딩 페이지 열기</button>
            <div id="analysisResult" class="result"></div>
        </div>

        <div class="section">
            <h3>3. 수동 테스트 URL</h3>
            <p>현재 활성 작업이 있다면 아래 링크들을 클릭해서 테스트할 수 있습니다:</p>
            <div id="testUrls"></div>
        </div>

        <div class="section">
            <h3>4. 직접 접속 가능한 URL</h3>
            <ul>
                <li><a href="/" target="_blank" class="url-link">API 정보</a></li>
                <li><a href="/docs" target="_blank" class="url-link">Swagger UI 문서</a></li>
                <li><a href="/health" target="_blank" class="url-link">헬스 체크</a></li>
                <li><a href="/api/tasks" target="_blank" class="url-link">활성 작업 목록</a></li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE = ''; // Use relative paths
        let currentTaskId = null;

        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                document.getElementById('healthResult').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('healthResult').textContent = `오류: ${error.message}`;
            }
        }

        async function getApiInfo() {
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                document.getElementById('healthResult').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('healthResult').textContent = `오류: ${error.message}`;
            }
        }

        async function getTasks() {
            try {
                const response = await fetch(`${API_BASE}/api/tasks`);
                const data = await response.json();
                document.getElementById('healthResult').textContent = JSON.stringify(data, null, 2);
                
                // 테스트 URL 업데이트
                updateTestUrls(data.tasks);
            } catch (error) {
                document.getElementById('healthResult').textContent = `오류: ${error.message}`;
            }
        }

        async function startAnalysis() {
            const testData = {
                analyze_data: {
                    "입지조건": 86,
                    "인프라": 78,
                    "안정성": 48
                },
                land_data: {
                    "주소": "대구광역시 중구 동인동1가 2-1",
                    "지목": "대",
                    "용도지역": "중심상업지역",
                    "용도지구": "지정되지않음",
                    "토지이용상황": "업무용",
                    "지형고저": "평지",
                    "형상": "세로장방",
                    "도로접면": "광대소각",
                    "공시지가": 3735000
                }
            };

            try {
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                if (response.ok) {
                    const result = await response.json();
                    currentTaskId = result.task_id;
                    
                    document.getElementById('analysisResult').innerHTML = `
분석 시작됨!
Task ID: ${currentTaskId}
상태: ${result.status}
메시지: ${result.message}

로딩 페이지가 새 창에서 열립니다...
                    `;

                    // 로딩 페이지 열기
                    window.open(`${API_BASE}/loading/${currentTaskId}`, '_blank');
                    
                    // 상태 모니터링 시작
                    monitorProgress(currentTaskId);
                    
                    // 테스트 URL 업데이트
                    updateTestUrlsForTask(currentTaskId);
                    
                } else {
                    const error = await response.text();
                    document.getElementById('analysisResult').textContent = `오류: ${error}`;
                }
            } catch (error) {
                document.getElementById('analysisResult').textContent = `오류: ${error.message}`;
            }
        }

        async function monitorProgress(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/status/${taskId}`);
                const status = await response.json();
                
                const statusElement = document.getElementById('analysisResult');
                const statusClass = status.status === 'completed' ? 'completed' : 
                                  status.status === 'error' ? 'error' : 'processing';
                
                statusElement.innerHTML = `
<div class="status ${statusClass}">
Task ID: ${taskId}
상태: ${status.status}
진행률: ${status.progress}%
메시지: ${status.message}
</div>

${status.status === 'completed' ? `
<p>✅ 분석 완료! 결과를 확인하세요:</p>
<a href="${API_BASE}/result/${taskId}" target="_blank" class="url-link">HTML 결과 보기</a>
` : status.status === 'error' ? `
<p>❌ 분석 오류: ${status.error}</p>
` : `
<p>⏳ 분석 진행 중... (자동 새로고침)</p>
`}
                `;

                if (status.status === 'processing') {
                    setTimeout(() => monitorProgress(taskId), 2000);
                }
            } catch (error) {
                console.error('상태 모니터링 오류:', error);
            }
        }

        function updateTestUrls(tasks) {
            const urlsDiv = document.getElementById('testUrls');
            if (tasks && tasks.length > 0) {
                let html = '<h4>현재 활성 작업들:</h4>';
                tasks.forEach(task => {
                    html += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                        <strong>Task ID:</strong> ${task.task_id}<br>
                        <strong>주소:</strong> ${task.land_address}<br>
                        <strong>상태:</strong> <span class="status ${task.status}">${task.status}</span><br>
                        <strong>진행률:</strong> ${task.progress}%<br>
                        <a href="${API_BASE}/loading/${task.task_id}" target="_blank" class="url-link">로딩 페이지</a> |
                        <a href="${API_BASE}/api/status/${task.task_id}" target="_blank" class="url-link">상태 확인</a>
                        ${task.status === 'completed' ? `| <a href="${API_BASE}/result/${task.task_id}" target="_blank" class="url-link">결과 보기</a>` : ''}
                    </div>
                    `;
                });
                urlsDiv.innerHTML = html;
            } else {
                urlsDiv.innerHTML = '<p>현재 활성 작업이 없습니다. 위에서 분석을 시작해보세요.</p>';
            }
        }

        function updateTestUrlsForTask(taskId) {
            const urlsDiv = document.getElementById('testUrls');
            urlsDiv.innerHTML = `
            <h4>현재 작업 테스트 URL:</h4>
            <div style="margin: 10px 0; padding: 10px; border: 1px solid #007bff; border-radius: 5px; background: #f0f8ff;">
                <strong>Task ID:</strong> ${taskId}<br>
                <a href="${API_BASE}/loading/${taskId}" target="_blank" class="url-link">🔄 로딩 페이지</a> |
                <a href="${API_BASE}/api/status/${taskId}" target="_blank" class="url-link">📊 상태 확인</a> |
                <a href="${API_BASE}/result/${taskId}" target="_blank" class="url-link">📄 결과 보기</a>
            </div>
            `;
        }

        // 페이지 로드 시 활성 작업 확인
        window.onload = function() {
            getTasks();
        };
    </script>
</body>
</html>